(self["webpackChunkcivil"] = self["webpackChunkcivil"] || []).push([["vendors-node_modules_strike-protocols_solana-wallet-adapter_lib_esm_index_js"],{

/***/ "./node_modules/@strike-protocols/solana-wallet-adapter/node_modules/bs58/index.js":
/*!*****************************************************************************************!*\
  !*** ./node_modules/@strike-protocols/solana-wallet-adapter/node_modules/bs58/index.js ***!
  \*****************************************************************************************/
/***/ ((module, __unused_webpack_exports, __webpack_require__) => {

var basex = __webpack_require__(/*! base-x */ "./node_modules/base-x/src/index.js")
var ALPHABET = '123456789ABCDEFGHJKLMNPQRSTUVWXYZabcdefghijkmnopqrstuvwxyz'

module.exports = basex(ALPHABET)


/***/ }),

/***/ "./node_modules/@strike-protocols/solana-wallet-adapter/lib/esm/index.js":
/*!*******************************************************************************!*\
  !*** ./node_modules/@strike-protocols/solana-wallet-adapter/lib/esm/index.js ***!
  \*******************************************************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "StrikeWallet": () => (/* reexport safe */ _strikewallet_js__WEBPACK_IMPORTED_MODULE_0__.StrikeWallet)
/* harmony export */ });
/* harmony import */ var _strikewallet_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! ./strikewallet.js */ "./node_modules/@strike-protocols/solana-wallet-adapter/lib/esm/strikewallet.js");

//# sourceMappingURL=index.js.map

/***/ }),

/***/ "./node_modules/@strike-protocols/solana-wallet-adapter/lib/esm/strikewallet.js":
/*!**************************************************************************************!*\
  !*** ./node_modules/@strike-protocols/solana-wallet-adapter/lib/esm/strikewallet.js ***!
  \**************************************************************************************/
/***/ ((__unused_webpack___webpack_module__, __webpack_exports__, __webpack_require__) => {

"use strict";
__webpack_require__.r(__webpack_exports__);
/* harmony export */ __webpack_require__.d(__webpack_exports__, {
/* harmony export */   "StrikeWallet": () => (/* binding */ StrikeWallet)
/* harmony export */ });
/* harmony import */ var _solana_web3_js__WEBPACK_IMPORTED_MODULE_0__ = __webpack_require__(/*! @solana/web3.js */ "./node_modules/@solana/web3.js/lib/index.browser.esm.js");
/* harmony import */ var bs58__WEBPACK_IMPORTED_MODULE_1__ = __webpack_require__(/*! bs58 */ "./node_modules/@strike-protocols/solana-wallet-adapter/node_modules/bs58/index.js");
/* harmony import */ var uuid__WEBPACK_IMPORTED_MODULE_3__ = __webpack_require__(/*! uuid */ "./node_modules/uuid/dist/esm-browser/v4.js");
/* harmony import */ var eventemitter3__WEBPACK_IMPORTED_MODULE_2__ = __webpack_require__(/*! eventemitter3 */ "./node_modules/eventemitter3/index.js");
/* provided dependency */ var Buffer = __webpack_require__(/*! buffer */ "./node_modules/buffer/index.js")["Buffer"];




const DEFAULT_SIGNATURE_BUFFER = Buffer.alloc(_solana_web3_js__WEBPACK_IMPORTED_MODULE_0__.SIGNATURE_LENGTH_IN_BYTES).fill(0);
class StrikeWallet extends eventemitter3__WEBPACK_IMPORTED_MODULE_2__.EventEmitter {
    constructor() {
        super();
        this.url = 'https://wallet.strikeprotocols.com';
        this.cleanUp = () => {
            [...this._timers].forEach(t => this.clearTimer(t));
            const wallet = this._wallet;
            if (wallet) {
                wallet.close();
            }
            this._wallet = null;
            this.emit('disconnected');
        };
        this.clearTimer = (timer) => {
            this._timers = this._timers.filter(t => t != timer);
            window.clearInterval(timer);
        };
        this.instructionsToSerializableInstructions = (instructions) => instructions.map(i => {
            return {
                'programId': i.programId.toBase58(),
                'accountMetas': i.keys.map(k => {
                    return {
                        address: k.pubkey.toBase58(),
                        signer: k.isSigner,
                        writable: k.isWritable,
                    };
                }),
                'data': window.btoa(String.fromCharCode(...i.data)),
            };
        });
        this.handleWalletMessage = (data) => {
            var _a, _b, _c;
            if (data.type == "connected") {
                this._connecting = false;
                if (!data.error) {
                    this.isLoggedIn = true;
                    if ((_a = data.connected) === null || _a === void 0 ? void 0 : _a.publicKey) {
                        this._publicKey = new _solana_web3_js__WEBPACK_IMPORTED_MODULE_0__.PublicKey(data.connected.publicKey);
                    }
                }
            }
            else if (["sendTransaction", "sendFinalTransaction"].includes(data.type)) {
                const transactionIdentifier = (_b = data.sendTransaction) === null || _b === void 0 ? void 0 : _b.identifier;
                if (transactionIdentifier && transactionIdentifier in this._pendingTransactions) {
                    if (data.error) {
                        this._pendingTransactionErrors[transactionIdentifier] = { message: data.error };
                    }
                    else {
                        this._pendingTransactions[transactionIdentifier] = data.sendTransaction || null;
                    }
                }
            }
            else if (data.type == "signTransaction") {
                const transactionIdentifier = (_c = data.signTransaction) === null || _c === void 0 ? void 0 : _c.identifier;
                if (transactionIdentifier && transactionIdentifier in this._pendingTransactions) {
                    if (data.error) {
                        this._pendingTransactionErrors[transactionIdentifier] = { message: data.error };
                    }
                    else {
                        this._pendingTransactions[transactionIdentifier] = data.signTransaction || null;
                    }
                }
            }
        };
        this.isLoggedIn = false;
        this._pendingTransactions = {};
        this._pendingTransactionErrors = {};
        this._timers = [];
        this._wallet = null;
        this._connecting = false;
        this._publicKey = null;
        window.addEventListener("message", (e) => {
            this.handleWalletMessage(e.data);
        });
    }
    async connect(url) {
        try {
            this.url = url || this.url;
            const origin = encodeURIComponent(window.location.origin);
            const connectUrl = `${this.url}/connect?origin=${origin}`;
            this._connecting = true;
            this._wallet = window.open(connectUrl, `strike-wallet-${origin}`, "height=900,width=800,menubar=no,status=no,toolbar=no");
            if (!this._wallet) {
                this._connecting = false;
                throw new Error("Unable to connect to wallet");
            }
            this._timers.push(window.setInterval(() => {
                if (this._wallet.closed) {
                    this.cleanUp();
                }
                else if (this._wallet) {
                    this._wallet.postMessage({ type: 'heartbeat' }, this.url);
                }
            }, 100));
            return new Promise((resolve, reject) => {
                const timer = window.setInterval(() => {
                    if (this.isLoggedIn && this._publicKey) {
                        this.clearTimer(timer);
                        resolve(this._publicKey);
                    }
                    else if (!this.isLoggedIn && !this._connecting) {
                        this.clearTimer(timer);
                        reject(new Error("Unable to connect to Strike"));
                    }
                }, 100);
                this._timers.push(timer);
            });
        }
        catch (error) {
            throw error;
        }
    }
    async signTransaction(transaction) {
        this.verifyCanSignRequests([transaction]);
        try {
            return this.signOneTransaction(transaction);
        }
        catch (error) {
            throw error;
        }
    }
    async signAllTransactions(transactions) {
        this.verifyCanSignRequests(transactions);
        try {
            return this.signMultipleTransactions(transactions);
        }
        catch (error) {
            throw error;
        }
    }
    async sendTransaction(transaction, connection, options) {
        try {
            const wallet = this._wallet;
            if (!wallet)
                throw new Error("Not Connected");
            const transactionIdentifier = (0,uuid__WEBPACK_IMPORTED_MODULE_3__["default"])();
            this._pendingTransactions[transactionIdentifier] = null;
            const signers = options ? options.signers : undefined;
            if (signers && signers.length > 0) {
                return new Promise((resolve, reject) => {
                    this.signOneTransaction(transaction, transactionIdentifier).then(walletTransaction => {
                        this._pendingTransactions[transactionIdentifier] = null;
                        (signers === null || signers === void 0 ? void 0 : signers.length) && walletTransaction.partialSign(...signers);
                        wallet.postMessage({
                            type: "sendFinalTransaction", sendFinalTransaction: {
                                transactionIdentifier,
                                signaturePubkeyPairs: walletTransaction.signatures.filter(sp => sp.signature != null).map(sp => {
                                    return {
                                        'pubkey': sp.publicKey.toBase58(),
                                        'signature': sp.signature.toString('base64')
                                    };
                                })
                            }
                        }, this.url);
                        const timer = window.setInterval(() => {
                            const pendingTransaction = this._pendingTransactions[transactionIdentifier];
                            const pendingTransactionError = this._pendingTransactionErrors[transactionIdentifier];
                            if (pendingTransaction != null || pendingTransactionError != null) {
                                this.clearTimer(timer);
                                pendingTransaction && resolve(pendingTransaction.signature);
                                pendingTransactionError && reject(pendingTransactionError);
                            }
                        }, 100);
                        this._timers.push(timer);
                    }).catch((error) => {
                        reject(error);
                        throw error;
                    });
                });
            }
            else {
                const instructions = this.instructionsToSerializableInstructions(transaction.instructions);
                return new Promise((resolve, reject) => {
                    wallet.postMessage({
                        type: "sendTransaction",
                        sendTransaction: { instructions, transactionIdentifier }
                    }, this.url);
                    const timer = window.setInterval(() => {
                        const pendingTransaction = this._pendingTransactions[transactionIdentifier];
                        const pendingTransactionError = this._pendingTransactionErrors[transactionIdentifier];
                        if (pendingTransaction != null || pendingTransactionError != null) {
                            this.clearTimer(timer);
                            pendingTransaction && resolve(pendingTransaction.signature);
                            pendingTransactionError && reject(pendingTransactionError);
                        }
                    }, 100);
                    this._timers.push(timer);
                });
            }
        }
        catch (error) {
            throw error;
        }
    }
    buildTransaction(pendingTransaction) {
        let message = _solana_web3_js__WEBPACK_IMPORTED_MODULE_0__.Message.from(Buffer.from(Uint8Array.from(window.atob(pendingTransaction.message), c => c.charCodeAt(0))));
        return _solana_web3_js__WEBPACK_IMPORTED_MODULE_0__.Transaction.populate(message, Array.from({ length: message.header.numRequiredSignatures }, (_v, i) => {
            let sigPubkeyPair = pendingTransaction.signatures.find(s => s.pubkey == message.accountKeys[i].toBase58());
            return bs58__WEBPACK_IMPORTED_MODULE_1__.encode(sigPubkeyPair
                ? Buffer.from(Uint8Array.from(window.atob(sigPubkeyPair.signature), c => c.charCodeAt(0)))
                : DEFAULT_SIGNATURE_BUFFER);
        }));
    }
    verifyCanSignRequests(transactions) {
        transactions.forEach(transaction => {
            if (transaction.signatures.some(s => s.signature != null)) {
                throw new Error("Strike does not support this signing mode");
            }
        });
    }
    signOneTransaction(transaction, transactionIdentifier = (0,uuid__WEBPACK_IMPORTED_MODULE_3__["default"])()) {
        const wallet = this._wallet;
        if (!wallet)
            throw new Error("Not Connected");
        const instructions = this.instructionsToSerializableInstructions(transaction.instructions);
        this._pendingTransactions[transactionIdentifier] = null;
        return new Promise((resolve, reject) => {
            wallet.postMessage({ type: "signTransaction", signTransaction: { instructions, transactionIdentifier } }, this.url);
            const timer = window.setInterval(() => {
                const pendingTransaction = this._pendingTransactions[transactionIdentifier];
                const pendingTransactionError = this._pendingTransactionErrors[transactionIdentifier];
                if (pendingTransaction != null || pendingTransactionError != null) {
                    this.clearTimer(timer);
                    pendingTransaction && resolve(this.buildTransaction(pendingTransaction));
                    pendingTransactionError && reject(pendingTransactionError);
                }
            }, 100);
            this._timers.push(timer);
        });
    }
    signMultipleTransactions(transactions) {
        const wallet = this._wallet;
        if (!wallet)
            throw new Error("Not Connected");
        const serializedTransactions = transactions.map((t) => {
            return {
                instructions: this.instructionsToSerializableInstructions(t.instructions),
                transactionIdentifier: (0,uuid__WEBPACK_IMPORTED_MODULE_3__["default"])()
            };
        });
        const transactionIdentifiers = serializedTransactions.map((t) => t.transactionIdentifier);
        transactionIdentifiers.forEach((transactionIdentifier) => this._pendingTransactions[transactionIdentifier] = null);
        return new Promise((resolve, reject) => {
            wallet.postMessage({ type: "signAllTransactions", signAllTransactions: { transactions: serializedTransactions } }, this.url);
            const timer = window.setInterval(() => {
                const pendingTransactions = transactionIdentifiers.map((txId) => this._pendingTransactions[txId]);
                const pendingTransactionErrors = transactionIdentifiers.map((txId) => this._pendingTransactionErrors[txId]);
                if (pendingTransactions.every((t) => t != null)) {
                    this.clearTimer(timer);
                    resolve(pendingTransactions.map((pt) => this.buildTransaction(pt)));
                }
                else if (pendingTransactionErrors.some((e) => e != null)) {
                    this.clearTimer(timer);
                    reject(pendingTransactionErrors.find((e) => e != null));
                }
            }, 100);
            this._timers.push(timer);
        });
    }
}
//# sourceMappingURL=strikewallet.js.map

/***/ })

}]);
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoidmVuZG9ycy1ub2RlX21vZHVsZXNfc3RyaWtlLXByb3RvY29sc19zb2xhbmEtd2FsbGV0LWFkYXB0ZXJfbGliX2VzbV9pbmRleF9qcy5idW5kbGUuanMiLCJtYXBwaW5ncyI6Ijs7Ozs7Ozs7QUFBQSxZQUFZLG1CQUFPLENBQUMsa0RBQVE7QUFDNUI7O0FBRUE7Ozs7Ozs7Ozs7Ozs7Ozs7O0FDSGtDO0FBQ2xDOzs7Ozs7Ozs7Ozs7Ozs7Ozs7OztBQ0Q2RjtBQUNyRTtBQUNZO0FBQ1M7QUFDN0MsaUNBQWlDLE1BQU0sT0FBTyxzRUFBeUI7QUFDaEUsMkJBQTJCLHVEQUFZO0FBQzlDO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsaUJBQWlCO0FBQ2pCO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSw4Q0FBOEMsc0RBQVM7QUFDdkQ7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrRkFBa0Y7QUFDbEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxrRkFBa0Y7QUFDbEY7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGtDQUFrQyxTQUFTLGtCQUFrQixPQUFPO0FBQ3BFO0FBQ0Esb0VBQW9FLE9BQU87QUFDM0U7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsK0NBQStDLG1CQUFtQjtBQUNsRTtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlCQUFpQjtBQUNqQjtBQUNBLGFBQWE7QUFDYjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLDBDQUEwQyxnREFBTTtBQUNoRDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUM7QUFDakM7QUFDQSx5QkFBeUI7QUFDekI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHlCQUF5QjtBQUN6QjtBQUNBLHFCQUFxQjtBQUNyQjtBQUNBO0FBQ0EscUJBQXFCO0FBQ3JCLGlCQUFpQjtBQUNqQjtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSwyQ0FBMkM7QUFDM0MscUJBQXFCO0FBQ3JCO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxxQkFBcUI7QUFDckI7QUFDQSxpQkFBaUI7QUFDakI7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxzQkFBc0IseURBQVksQ0FBQyxNQUFNO0FBQ3pDLGVBQWUsaUVBQW9CLHVCQUF1Qiw4Q0FBOEM7QUFDeEc7QUFDQSxtQkFBbUIsd0NBQVc7QUFDOUIsa0JBQWtCLE1BQU07QUFDeEI7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsU0FBUztBQUNUO0FBQ0EsNERBQTRELGdEQUFNO0FBQ2xFO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLGlDQUFpQyw0Q0FBNEMsdUNBQXVDO0FBQ3BIO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQSxhQUFhO0FBQ2I7QUFDQSxTQUFTO0FBQ1Q7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLHVDQUF1QyxnREFBTTtBQUM3QztBQUNBLFNBQVM7QUFDVDtBQUNBO0FBQ0E7QUFDQSxpQ0FBaUMsb0RBQW9ELHdDQUF3QztBQUM3SDtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBO0FBQ0EsYUFBYTtBQUNiO0FBQ0EsU0FBUztBQUNUO0FBQ0E7QUFDQSIsInNvdXJjZXMiOlsid2VicGFjazovL2NpdmlsLy4vbm9kZV9tb2R1bGVzL0BzdHJpa2UtcHJvdG9jb2xzL3NvbGFuYS13YWxsZXQtYWRhcHRlci9ub2RlX21vZHVsZXMvYnM1OC9pbmRleC5qcyIsIndlYnBhY2s6Ly9jaXZpbC8uL25vZGVfbW9kdWxlcy9Ac3RyaWtlLXByb3RvY29scy9zb2xhbmEtd2FsbGV0LWFkYXB0ZXIvbGliL2VzbS9pbmRleC5qcyIsIndlYnBhY2s6Ly9jaXZpbC8uL25vZGVfbW9kdWxlcy9Ac3RyaWtlLXByb3RvY29scy9zb2xhbmEtd2FsbGV0LWFkYXB0ZXIvbGliL2VzbS9zdHJpa2V3YWxsZXQuanMiXSwic291cmNlc0NvbnRlbnQiOlsidmFyIGJhc2V4ID0gcmVxdWlyZSgnYmFzZS14JylcbnZhciBBTFBIQUJFVCA9ICcxMjM0NTY3ODlBQkNERUZHSEpLTE1OUFFSU1RVVldYWVphYmNkZWZnaGlqa21ub3BxcnN0dXZ3eHl6J1xuXG5tb2R1bGUuZXhwb3J0cyA9IGJhc2V4KEFMUEhBQkVUKVxuIiwiZXhwb3J0ICogZnJvbSAnLi9zdHJpa2V3YWxsZXQuanMnO1xuLy8jIHNvdXJjZU1hcHBpbmdVUkw9aW5kZXguanMubWFwIiwiaW1wb3J0IHsgTWVzc2FnZSwgUHVibGljS2V5LCBTSUdOQVRVUkVfTEVOR1RIX0lOX0JZVEVTLCBUcmFuc2FjdGlvbiB9IGZyb20gXCJAc29sYW5hL3dlYjMuanNcIjtcbmltcG9ydCBiczU4IGZyb20gXCJiczU4XCI7XG5pbXBvcnQgeyB2NCBhcyB1dWlkdjQgfSBmcm9tIFwidXVpZFwiO1xuaW1wb3J0IHsgRXZlbnRFbWl0dGVyIH0gZnJvbSBcImV2ZW50ZW1pdHRlcjNcIjtcbmNvbnN0IERFRkFVTFRfU0lHTkFUVVJFX0JVRkZFUiA9IEJ1ZmZlci5hbGxvYyhTSUdOQVRVUkVfTEVOR1RIX0lOX0JZVEVTKS5maWxsKDApO1xuZXhwb3J0IGNsYXNzIFN0cmlrZVdhbGxldCBleHRlbmRzIEV2ZW50RW1pdHRlciB7XG4gICAgY29uc3RydWN0b3IoKSB7XG4gICAgICAgIHN1cGVyKCk7XG4gICAgICAgIHRoaXMudXJsID0gJ2h0dHBzOi8vd2FsbGV0LnN0cmlrZXByb3RvY29scy5jb20nO1xuICAgICAgICB0aGlzLmNsZWFuVXAgPSAoKSA9PiB7XG4gICAgICAgICAgICBbLi4udGhpcy5fdGltZXJzXS5mb3JFYWNoKHQgPT4gdGhpcy5jbGVhclRpbWVyKHQpKTtcbiAgICAgICAgICAgIGNvbnN0IHdhbGxldCA9IHRoaXMuX3dhbGxldDtcbiAgICAgICAgICAgIGlmICh3YWxsZXQpIHtcbiAgICAgICAgICAgICAgICB3YWxsZXQuY2xvc2UoKTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICAgIHRoaXMuX3dhbGxldCA9IG51bGw7XG4gICAgICAgICAgICB0aGlzLmVtaXQoJ2Rpc2Nvbm5lY3RlZCcpO1xuICAgICAgICB9O1xuICAgICAgICB0aGlzLmNsZWFyVGltZXIgPSAodGltZXIpID0+IHtcbiAgICAgICAgICAgIHRoaXMuX3RpbWVycyA9IHRoaXMuX3RpbWVycy5maWx0ZXIodCA9PiB0ICE9IHRpbWVyKTtcbiAgICAgICAgICAgIHdpbmRvdy5jbGVhckludGVydmFsKHRpbWVyKTtcbiAgICAgICAgfTtcbiAgICAgICAgdGhpcy5pbnN0cnVjdGlvbnNUb1NlcmlhbGl6YWJsZUluc3RydWN0aW9ucyA9IChpbnN0cnVjdGlvbnMpID0+IGluc3RydWN0aW9ucy5tYXAoaSA9PiB7XG4gICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICdwcm9ncmFtSWQnOiBpLnByb2dyYW1JZC50b0Jhc2U1OCgpLFxuICAgICAgICAgICAgICAgICdhY2NvdW50TWV0YXMnOiBpLmtleXMubWFwKGsgPT4ge1xuICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgYWRkcmVzczogay5wdWJrZXkudG9CYXNlNTgoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgIHNpZ25lcjogay5pc1NpZ25lcixcbiAgICAgICAgICAgICAgICAgICAgICAgIHdyaXRhYmxlOiBrLmlzV3JpdGFibGUsXG4gICAgICAgICAgICAgICAgICAgIH07XG4gICAgICAgICAgICAgICAgfSksXG4gICAgICAgICAgICAgICAgJ2RhdGEnOiB3aW5kb3cuYnRvYShTdHJpbmcuZnJvbUNoYXJDb2RlKC4uLmkuZGF0YSkpLFxuICAgICAgICAgICAgfTtcbiAgICAgICAgfSk7XG4gICAgICAgIHRoaXMuaGFuZGxlV2FsbGV0TWVzc2FnZSA9IChkYXRhKSA9PiB7XG4gICAgICAgICAgICB2YXIgX2EsIF9iLCBfYztcbiAgICAgICAgICAgIGlmIChkYXRhLnR5cGUgPT0gXCJjb25uZWN0ZWRcIikge1xuICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3RpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICBpZiAoIWRhdGEuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5pc0xvZ2dlZEluID0gdHJ1ZTtcbiAgICAgICAgICAgICAgICAgICAgaWYgKChfYSA9IGRhdGEuY29ubmVjdGVkKSA9PT0gbnVsbCB8fCBfYSA9PT0gdm9pZCAwID8gdm9pZCAwIDogX2EucHVibGljS2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wdWJsaWNLZXkgPSBuZXcgUHVibGljS2V5KGRhdGEuY29ubmVjdGVkLnB1YmxpY0tleSk7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICBlbHNlIGlmIChbXCJzZW5kVHJhbnNhY3Rpb25cIiwgXCJzZW5kRmluYWxUcmFuc2FjdGlvblwiXS5pbmNsdWRlcyhkYXRhLnR5cGUpKSB7XG4gICAgICAgICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb25JZGVudGlmaWVyID0gKF9iID0gZGF0YS5zZW5kVHJhbnNhY3Rpb24pID09PSBudWxsIHx8IF9iID09PSB2b2lkIDAgPyB2b2lkIDAgOiBfYi5pZGVudGlmaWVyO1xuICAgICAgICAgICAgICAgIGlmICh0cmFuc2FjdGlvbklkZW50aWZpZXIgJiYgdHJhbnNhY3Rpb25JZGVudGlmaWVyIGluIHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbnMpIHtcbiAgICAgICAgICAgICAgICAgICAgaWYgKGRhdGEuZXJyb3IpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbkVycm9yc1t0cmFuc2FjdGlvbklkZW50aWZpZXJdID0geyBtZXNzYWdlOiBkYXRhLmVycm9yIH07XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLl9wZW5kaW5nVHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRlbnRpZmllcl0gPSBkYXRhLnNlbmRUcmFuc2FjdGlvbiB8fCBudWxsO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSBpZiAoZGF0YS50eXBlID09IFwic2lnblRyYW5zYWN0aW9uXCIpIHtcbiAgICAgICAgICAgICAgICBjb25zdCB0cmFuc2FjdGlvbklkZW50aWZpZXIgPSAoX2MgPSBkYXRhLnNpZ25UcmFuc2FjdGlvbikgPT09IG51bGwgfHwgX2MgPT09IHZvaWQgMCA/IHZvaWQgMCA6IF9jLmlkZW50aWZpZXI7XG4gICAgICAgICAgICAgICAgaWYgKHRyYW5zYWN0aW9uSWRlbnRpZmllciAmJiB0cmFuc2FjdGlvbklkZW50aWZpZXIgaW4gdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9ucykge1xuICAgICAgICAgICAgICAgICAgICBpZiAoZGF0YS5lcnJvcikge1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9uRXJyb3JzW3RyYW5zYWN0aW9uSWRlbnRpZmllcl0gPSB7IG1lc3NhZ2U6IGRhdGEuZXJyb3IgfTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICBlbHNlIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZGVudGlmaWVyXSA9IGRhdGEuc2lnblRyYW5zYWN0aW9uIHx8IG51bGw7XG4gICAgICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9XG4gICAgICAgIH07XG4gICAgICAgIHRoaXMuaXNMb2dnZWRJbiA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9wZW5kaW5nVHJhbnNhY3Rpb25zID0ge307XG4gICAgICAgIHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbkVycm9ycyA9IHt9O1xuICAgICAgICB0aGlzLl90aW1lcnMgPSBbXTtcbiAgICAgICAgdGhpcy5fd2FsbGV0ID0gbnVsbDtcbiAgICAgICAgdGhpcy5fY29ubmVjdGluZyA9IGZhbHNlO1xuICAgICAgICB0aGlzLl9wdWJsaWNLZXkgPSBudWxsO1xuICAgICAgICB3aW5kb3cuYWRkRXZlbnRMaXN0ZW5lcihcIm1lc3NhZ2VcIiwgKGUpID0+IHtcbiAgICAgICAgICAgIHRoaXMuaGFuZGxlV2FsbGV0TWVzc2FnZShlLmRhdGEpO1xuICAgICAgICB9KTtcbiAgICB9XG4gICAgYXN5bmMgY29ubmVjdCh1cmwpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHRoaXMudXJsID0gdXJsIHx8IHRoaXMudXJsO1xuICAgICAgICAgICAgY29uc3Qgb3JpZ2luID0gZW5jb2RlVVJJQ29tcG9uZW50KHdpbmRvdy5sb2NhdGlvbi5vcmlnaW4pO1xuICAgICAgICAgICAgY29uc3QgY29ubmVjdFVybCA9IGAke3RoaXMudXJsfS9jb25uZWN0P29yaWdpbj0ke29yaWdpbn1gO1xuICAgICAgICAgICAgdGhpcy5fY29ubmVjdGluZyA9IHRydWU7XG4gICAgICAgICAgICB0aGlzLl93YWxsZXQgPSB3aW5kb3cub3Blbihjb25uZWN0VXJsLCBgc3RyaWtlLXdhbGxldC0ke29yaWdpbn1gLCBcImhlaWdodD05MDAsd2lkdGg9ODAwLG1lbnViYXI9bm8sc3RhdHVzPW5vLHRvb2xiYXI9bm9cIik7XG4gICAgICAgICAgICBpZiAoIXRoaXMuX3dhbGxldCkge1xuICAgICAgICAgICAgICAgIHRoaXMuX2Nvbm5lY3RpbmcgPSBmYWxzZTtcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJVbmFibGUgdG8gY29ubmVjdCB0byB3YWxsZXRcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgICB0aGlzLl90aW1lcnMucHVzaCh3aW5kb3cuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGlmICh0aGlzLl93YWxsZXQuY2xvc2VkKSB7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYW5VcCgpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgICAgICBlbHNlIGlmICh0aGlzLl93YWxsZXQpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5fd2FsbGV0LnBvc3RNZXNzYWdlKHsgdHlwZTogJ2hlYXJ0YmVhdCcgfSwgdGhpcy51cmwpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDEwMCkpO1xuICAgICAgICAgICAgcmV0dXJuIG5ldyBQcm9taXNlKChyZXNvbHZlLCByZWplY3QpID0+IHtcbiAgICAgICAgICAgICAgICBjb25zdCB0aW1lciA9IHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIGlmICh0aGlzLmlzTG9nZ2VkSW4gJiYgdGhpcy5fcHVibGljS2V5KSB7XG4gICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZSh0aGlzLl9wdWJsaWNLZXkpO1xuICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIGVsc2UgaWYgKCF0aGlzLmlzTG9nZ2VkSW4gJiYgIXRoaXMuX2Nvbm5lY3RpbmcpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuY2xlYXJUaW1lcih0aW1lcik7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QobmV3IEVycm9yKFwiVW5hYmxlIHRvIGNvbm5lY3QgdG8gU3RyaWtlXCIpKTtcbiAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgICAgICAgICAgdGhpcy5fdGltZXJzLnB1c2godGltZXIpO1xuICAgICAgICAgICAgfSk7XG4gICAgICAgIH1cbiAgICAgICAgY2F0Y2ggKGVycm9yKSB7XG4gICAgICAgICAgICB0aHJvdyBlcnJvcjtcbiAgICAgICAgfVxuICAgIH1cbiAgICBhc3luYyBzaWduVHJhbnNhY3Rpb24odHJhbnNhY3Rpb24pIHtcbiAgICAgICAgdGhpcy52ZXJpZnlDYW5TaWduUmVxdWVzdHMoW3RyYW5zYWN0aW9uXSk7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICByZXR1cm4gdGhpcy5zaWduT25lVHJhbnNhY3Rpb24odHJhbnNhY3Rpb24pO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXN5bmMgc2lnbkFsbFRyYW5zYWN0aW9ucyh0cmFuc2FjdGlvbnMpIHtcbiAgICAgICAgdGhpcy52ZXJpZnlDYW5TaWduUmVxdWVzdHModHJhbnNhY3Rpb25zKTtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIHJldHVybiB0aGlzLnNpZ25NdWx0aXBsZVRyYW5zYWN0aW9ucyh0cmFuc2FjdGlvbnMpO1xuICAgICAgICB9XG4gICAgICAgIGNhdGNoIChlcnJvcikge1xuICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgIH1cbiAgICB9XG4gICAgYXN5bmMgc2VuZFRyYW5zYWN0aW9uKHRyYW5zYWN0aW9uLCBjb25uZWN0aW9uLCBvcHRpb25zKSB7XG4gICAgICAgIHRyeSB7XG4gICAgICAgICAgICBjb25zdCB3YWxsZXQgPSB0aGlzLl93YWxsZXQ7XG4gICAgICAgICAgICBpZiAoIXdhbGxldClcbiAgICAgICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJOb3QgQ29ubmVjdGVkXCIpO1xuICAgICAgICAgICAgY29uc3QgdHJhbnNhY3Rpb25JZGVudGlmaWVyID0gdXVpZHY0KCk7XG4gICAgICAgICAgICB0aGlzLl9wZW5kaW5nVHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRlbnRpZmllcl0gPSBudWxsO1xuICAgICAgICAgICAgY29uc3Qgc2lnbmVycyA9IG9wdGlvbnMgPyBvcHRpb25zLnNpZ25lcnMgOiB1bmRlZmluZWQ7XG4gICAgICAgICAgICBpZiAoc2lnbmVycyAmJiBzaWduZXJzLmxlbmd0aCA+IDApIHtcbiAgICAgICAgICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgICAgICAgICB0aGlzLnNpZ25PbmVUcmFuc2FjdGlvbih0cmFuc2FjdGlvbiwgdHJhbnNhY3Rpb25JZGVudGlmaWVyKS50aGVuKHdhbGxldFRyYW5zYWN0aW9uID0+IHtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZGVudGlmaWVyXSA9IG51bGw7XG4gICAgICAgICAgICAgICAgICAgICAgICAoc2lnbmVycyA9PT0gbnVsbCB8fCBzaWduZXJzID09PSB2b2lkIDAgPyB2b2lkIDAgOiBzaWduZXJzLmxlbmd0aCkgJiYgd2FsbGV0VHJhbnNhY3Rpb24ucGFydGlhbFNpZ24oLi4uc2lnbmVycyk7XG4gICAgICAgICAgICAgICAgICAgICAgICB3YWxsZXQucG9zdE1lc3NhZ2Uoe1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHR5cGU6IFwic2VuZEZpbmFsVHJhbnNhY3Rpb25cIiwgc2VuZEZpbmFsVHJhbnNhY3Rpb246IHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhbnNhY3Rpb25JZGVudGlmaWVyLFxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBzaWduYXR1cmVQdWJrZXlQYWlyczogd2FsbGV0VHJhbnNhY3Rpb24uc2lnbmF0dXJlcy5maWx0ZXIoc3AgPT4gc3Auc2lnbmF0dXJlICE9IG51bGwpLm1hcChzcCA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICByZXR1cm4ge1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICdwdWJrZXknOiBzcC5wdWJsaWNLZXkudG9CYXNlNTgoKSxcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAnc2lnbmF0dXJlJzogc3Auc2lnbmF0dXJlLnRvU3RyaW5nKCdiYXNlNjQnKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgfSlcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgICAgICB9LCB0aGlzLnVybCk7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lciA9IHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgY29uc3QgcGVuZGluZ1RyYW5zYWN0aW9uID0gdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkZW50aWZpZXJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNvbnN0IHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yID0gdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9uRXJyb3JzW3RyYW5zYWN0aW9uSWRlbnRpZmllcl07XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdUcmFuc2FjdGlvbiAhPSBudWxsIHx8IHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclRpbWVyKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcGVuZGluZ1RyYW5zYWN0aW9uICYmIHJlc29sdmUocGVuZGluZ1RyYW5zYWN0aW9uLnNpZ25hdHVyZSk7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yICYmIHJlamVjdChwZW5kaW5nVHJhbnNhY3Rpb25FcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICAgICAgfVxuICAgICAgICAgICAgICAgICAgICAgICAgfSwgMTAwKTtcbiAgICAgICAgICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVycy5wdXNoKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgfSkuY2F0Y2goKGVycm9yKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICByZWplY3QoZXJyb3IpO1xuICAgICAgICAgICAgICAgICAgICAgICAgdGhyb3cgZXJyb3I7XG4gICAgICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgICAgIH0pO1xuICAgICAgICAgICAgfVxuICAgICAgICAgICAgZWxzZSB7XG4gICAgICAgICAgICAgICAgY29uc3QgaW5zdHJ1Y3Rpb25zID0gdGhpcy5pbnN0cnVjdGlvbnNUb1NlcmlhbGl6YWJsZUluc3RydWN0aW9ucyh0cmFuc2FjdGlvbi5pbnN0cnVjdGlvbnMpO1xuICAgICAgICAgICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICAgICAgICAgIHdhbGxldC5wb3N0TWVzc2FnZSh7XG4gICAgICAgICAgICAgICAgICAgICAgICB0eXBlOiBcInNlbmRUcmFuc2FjdGlvblwiLFxuICAgICAgICAgICAgICAgICAgICAgICAgc2VuZFRyYW5zYWN0aW9uOiB7IGluc3RydWN0aW9ucywgdHJhbnNhY3Rpb25JZGVudGlmaWVyIH1cbiAgICAgICAgICAgICAgICAgICAgfSwgdGhpcy51cmwpO1xuICAgICAgICAgICAgICAgICAgICBjb25zdCB0aW1lciA9IHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwZW5kaW5nVHJhbnNhY3Rpb24gPSB0aGlzLl9wZW5kaW5nVHJhbnNhY3Rpb25zW3RyYW5zYWN0aW9uSWRlbnRpZmllcl07XG4gICAgICAgICAgICAgICAgICAgICAgICBjb25zdCBwZW5kaW5nVHJhbnNhY3Rpb25FcnJvciA9IHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbkVycm9yc1t0cmFuc2FjdGlvbklkZW50aWZpZXJdO1xuICAgICAgICAgICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdUcmFuc2FjdGlvbiAhPSBudWxsIHx8IHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgICAgICAgICB0aGlzLmNsZWFyVGltZXIodGltZXIpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmdUcmFuc2FjdGlvbiAmJiByZXNvbHZlKHBlbmRpbmdUcmFuc2FjdGlvbi5zaWduYXR1cmUpO1xuICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yICYmIHJlamVjdChwZW5kaW5nVHJhbnNhY3Rpb25FcnJvcik7XG4gICAgICAgICAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgICAgICAgICAgICAgIHRoaXMuX3RpbWVycy5wdXNoKHRpbWVyKTtcbiAgICAgICAgICAgICAgICB9KTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyb3IpIHtcbiAgICAgICAgICAgIHRocm93IGVycm9yO1xuICAgICAgICB9XG4gICAgfVxuICAgIGJ1aWxkVHJhbnNhY3Rpb24ocGVuZGluZ1RyYW5zYWN0aW9uKSB7XG4gICAgICAgIGxldCBtZXNzYWdlID0gTWVzc2FnZS5mcm9tKEJ1ZmZlci5mcm9tKFVpbnQ4QXJyYXkuZnJvbSh3aW5kb3cuYXRvYihwZW5kaW5nVHJhbnNhY3Rpb24ubWVzc2FnZSksIGMgPT4gYy5jaGFyQ29kZUF0KDApKSkpO1xuICAgICAgICByZXR1cm4gVHJhbnNhY3Rpb24ucG9wdWxhdGUobWVzc2FnZSwgQXJyYXkuZnJvbSh7IGxlbmd0aDogbWVzc2FnZS5oZWFkZXIubnVtUmVxdWlyZWRTaWduYXR1cmVzIH0sIChfdiwgaSkgPT4ge1xuICAgICAgICAgICAgbGV0IHNpZ1B1YmtleVBhaXIgPSBwZW5kaW5nVHJhbnNhY3Rpb24uc2lnbmF0dXJlcy5maW5kKHMgPT4gcy5wdWJrZXkgPT0gbWVzc2FnZS5hY2NvdW50S2V5c1tpXS50b0Jhc2U1OCgpKTtcbiAgICAgICAgICAgIHJldHVybiBiczU4LmVuY29kZShzaWdQdWJrZXlQYWlyXG4gICAgICAgICAgICAgICAgPyBCdWZmZXIuZnJvbShVaW50OEFycmF5LmZyb20od2luZG93LmF0b2Ioc2lnUHVia2V5UGFpci5zaWduYXR1cmUpLCBjID0+IGMuY2hhckNvZGVBdCgwKSkpXG4gICAgICAgICAgICAgICAgOiBERUZBVUxUX1NJR05BVFVSRV9CVUZGRVIpO1xuICAgICAgICB9KSk7XG4gICAgfVxuICAgIHZlcmlmeUNhblNpZ25SZXF1ZXN0cyh0cmFuc2FjdGlvbnMpIHtcbiAgICAgICAgdHJhbnNhY3Rpb25zLmZvckVhY2godHJhbnNhY3Rpb24gPT4ge1xuICAgICAgICAgICAgaWYgKHRyYW5zYWN0aW9uLnNpZ25hdHVyZXMuc29tZShzID0+IHMuc2lnbmF0dXJlICE9IG51bGwpKSB7XG4gICAgICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKFwiU3RyaWtlIGRvZXMgbm90IHN1cHBvcnQgdGhpcyBzaWduaW5nIG1vZGVcIik7XG4gICAgICAgICAgICB9XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzaWduT25lVHJhbnNhY3Rpb24odHJhbnNhY3Rpb24sIHRyYW5zYWN0aW9uSWRlbnRpZmllciA9IHV1aWR2NCgpKSB7XG4gICAgICAgIGNvbnN0IHdhbGxldCA9IHRoaXMuX3dhbGxldDtcbiAgICAgICAgaWYgKCF3YWxsZXQpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJOb3QgQ29ubmVjdGVkXCIpO1xuICAgICAgICBjb25zdCBpbnN0cnVjdGlvbnMgPSB0aGlzLmluc3RydWN0aW9uc1RvU2VyaWFsaXphYmxlSW5zdHJ1Y3Rpb25zKHRyYW5zYWN0aW9uLmluc3RydWN0aW9ucyk7XG4gICAgICAgIHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZGVudGlmaWVyXSA9IG51bGw7XG4gICAgICAgIHJldHVybiBuZXcgUHJvbWlzZSgocmVzb2x2ZSwgcmVqZWN0KSA9PiB7XG4gICAgICAgICAgICB3YWxsZXQucG9zdE1lc3NhZ2UoeyB0eXBlOiBcInNpZ25UcmFuc2FjdGlvblwiLCBzaWduVHJhbnNhY3Rpb246IHsgaW5zdHJ1Y3Rpb25zLCB0cmFuc2FjdGlvbklkZW50aWZpZXIgfSB9LCB0aGlzLnVybCk7XG4gICAgICAgICAgICBjb25zdCB0aW1lciA9IHdpbmRvdy5zZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgICAgICAgY29uc3QgcGVuZGluZ1RyYW5zYWN0aW9uID0gdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9uc1t0cmFuc2FjdGlvbklkZW50aWZpZXJdO1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yID0gdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9uRXJyb3JzW3RyYW5zYWN0aW9uSWRlbnRpZmllcl07XG4gICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdUcmFuc2FjdGlvbiAhPSBudWxsIHx8IHBlbmRpbmdUcmFuc2FjdGlvbkVycm9yICE9IG51bGwpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclRpbWVyKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgcGVuZGluZ1RyYW5zYWN0aW9uICYmIHJlc29sdmUodGhpcy5idWlsZFRyYW5zYWN0aW9uKHBlbmRpbmdUcmFuc2FjdGlvbikpO1xuICAgICAgICAgICAgICAgICAgICBwZW5kaW5nVHJhbnNhY3Rpb25FcnJvciAmJiByZWplY3QocGVuZGluZ1RyYW5zYWN0aW9uRXJyb3IpO1xuICAgICAgICAgICAgICAgIH1cbiAgICAgICAgICAgIH0sIDEwMCk7XG4gICAgICAgICAgICB0aGlzLl90aW1lcnMucHVzaCh0aW1lcik7XG4gICAgICAgIH0pO1xuICAgIH1cbiAgICBzaWduTXVsdGlwbGVUcmFuc2FjdGlvbnModHJhbnNhY3Rpb25zKSB7XG4gICAgICAgIGNvbnN0IHdhbGxldCA9IHRoaXMuX3dhbGxldDtcbiAgICAgICAgaWYgKCF3YWxsZXQpXG4gICAgICAgICAgICB0aHJvdyBuZXcgRXJyb3IoXCJOb3QgQ29ubmVjdGVkXCIpO1xuICAgICAgICBjb25zdCBzZXJpYWxpemVkVHJhbnNhY3Rpb25zID0gdHJhbnNhY3Rpb25zLm1hcCgodCkgPT4ge1xuICAgICAgICAgICAgcmV0dXJuIHtcbiAgICAgICAgICAgICAgICBpbnN0cnVjdGlvbnM6IHRoaXMuaW5zdHJ1Y3Rpb25zVG9TZXJpYWxpemFibGVJbnN0cnVjdGlvbnModC5pbnN0cnVjdGlvbnMpLFxuICAgICAgICAgICAgICAgIHRyYW5zYWN0aW9uSWRlbnRpZmllcjogdXVpZHY0KClcbiAgICAgICAgICAgIH07XG4gICAgICAgIH0pO1xuICAgICAgICBjb25zdCB0cmFuc2FjdGlvbklkZW50aWZpZXJzID0gc2VyaWFsaXplZFRyYW5zYWN0aW9ucy5tYXAoKHQpID0+IHQudHJhbnNhY3Rpb25JZGVudGlmaWVyKTtcbiAgICAgICAgdHJhbnNhY3Rpb25JZGVudGlmaWVycy5mb3JFYWNoKCh0cmFuc2FjdGlvbklkZW50aWZpZXIpID0+IHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbnNbdHJhbnNhY3Rpb25JZGVudGlmaWVyXSA9IG51bGwpO1xuICAgICAgICByZXR1cm4gbmV3IFByb21pc2UoKHJlc29sdmUsIHJlamVjdCkgPT4ge1xuICAgICAgICAgICAgd2FsbGV0LnBvc3RNZXNzYWdlKHsgdHlwZTogXCJzaWduQWxsVHJhbnNhY3Rpb25zXCIsIHNpZ25BbGxUcmFuc2FjdGlvbnM6IHsgdHJhbnNhY3Rpb25zOiBzZXJpYWxpemVkVHJhbnNhY3Rpb25zIH0gfSwgdGhpcy51cmwpO1xuICAgICAgICAgICAgY29uc3QgdGltZXIgPSB3aW5kb3cuc2V0SW50ZXJ2YWwoKCkgPT4ge1xuICAgICAgICAgICAgICAgIGNvbnN0IHBlbmRpbmdUcmFuc2FjdGlvbnMgPSB0cmFuc2FjdGlvbklkZW50aWZpZXJzLm1hcCgodHhJZCkgPT4gdGhpcy5fcGVuZGluZ1RyYW5zYWN0aW9uc1t0eElkXSk7XG4gICAgICAgICAgICAgICAgY29uc3QgcGVuZGluZ1RyYW5zYWN0aW9uRXJyb3JzID0gdHJhbnNhY3Rpb25JZGVudGlmaWVycy5tYXAoKHR4SWQpID0+IHRoaXMuX3BlbmRpbmdUcmFuc2FjdGlvbkVycm9yc1t0eElkXSk7XG4gICAgICAgICAgICAgICAgaWYgKHBlbmRpbmdUcmFuc2FjdGlvbnMuZXZlcnkoKHQpID0+IHQgIT0gbnVsbCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclRpbWVyKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmVzb2x2ZShwZW5kaW5nVHJhbnNhY3Rpb25zLm1hcCgocHQpID0+IHRoaXMuYnVpbGRUcmFuc2FjdGlvbihwdCkpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICAgICAgZWxzZSBpZiAocGVuZGluZ1RyYW5zYWN0aW9uRXJyb3JzLnNvbWUoKGUpID0+IGUgIT0gbnVsbCkpIHtcbiAgICAgICAgICAgICAgICAgICAgdGhpcy5jbGVhclRpbWVyKHRpbWVyKTtcbiAgICAgICAgICAgICAgICAgICAgcmVqZWN0KHBlbmRpbmdUcmFuc2FjdGlvbkVycm9ycy5maW5kKChlKSA9PiBlICE9IG51bGwpKTtcbiAgICAgICAgICAgICAgICB9XG4gICAgICAgICAgICB9LCAxMDApO1xuICAgICAgICAgICAgdGhpcy5fdGltZXJzLnB1c2godGltZXIpO1xuICAgICAgICB9KTtcbiAgICB9XG59XG4vLyMgc291cmNlTWFwcGluZ1VSTD1zdHJpa2V3YWxsZXQuanMubWFwIl0sIm5hbWVzIjpbXSwic291cmNlUm9vdCI6IiJ9